from sklearn_extra.cluster import KMedoids
from sklearn.preprocessing import StandardScaler
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.decomposition import PCA
import pandas as pd
import numpy as np

# Ensure X_scaled is available from previous steps
if 'X_scaled' not in locals():
    print("X_scaled not found. Scaling data now...")
    if 'data_encoded' not in locals():
        data_encoded = pd.get_dummies(data, columns=['Product Category', 'Payment Method', 'Gender'], drop_first=True)
        data_encoded = data_encoded.drop(['Customer ID', 'Customer Name', 'Purchase Date'], axis=1)

    X = data_encoded.drop('Churn', axis=1)
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)

# Sample the data to reduce execution time for K-Medoids
sample_fraction = 0.1 # Use 10% of the data for faster processing
sampled_indices_kmedoids = np.random.choice(X_scaled.shape[0], int(X_scaled.shape[0] * sample_fraction), replace=False)
X_scaled_sampled_kmedoids = X_scaled[sampled_indices_kmedoids]
data_with_kmedoids_clusters_sampled = data_encoded.iloc[sampled_indices_kmedoids].copy()

# K-Medoids parameters
n_kmedoids_clusters = 3 # You can adjust the number of clusters as needed
kmedoids_model = KMedoids(n_clusters=n_kmedoids_clusters, random_state=42)

# Fit the model and predict clusters on the sampled data
clusters_kmedoids = kmedoids_model.fit_predict(X_scaled_sampled_kmedoids)

# Add cluster labels to the sampled DataFrame for analysis
data_with_kmedoids_clusters_sampled['KMedoids_Cluster'] = clusters_kmedoids

print(f"Distribution of customers across K-Medoids clusters (on sampled data):")
display(data_with_kmedoids_clusters_sampled['KMedoids_Cluster'].value_counts().sort_index())

# Visualize the clusters
pca_kmedoids = PCA(n_components=2) # Reduce to 2 dimensions for plotting
X_pca_sampled_kmedoids = pca_kmedoids.fit_transform(X_scaled_sampled_kmedoids)

plt.figure(figsize=(10, 8))
sns.scatterplot(x=X_pca_sampled_kmedoids[:, 0], y=X_pca_sampled_kmedoids[:, 1],
                hue=data_with_kmedoids_clusters_sampled['KMedoids_Cluster'],
                palette='viridis', legend='full', s=50, alpha=0.7)
plt.title('K-Medoids Clusters (PCA-reduced Sampled Data)')
plt.xlabel('PCA Component 1')
plt.ylabel('PCA Component 2')
plt.show()
